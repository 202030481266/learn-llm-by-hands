name: PR Agent

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited, dismissed]

jobs:
  pr_agent_job:
    if: ${{ github.event.sender.type != 'Bot' }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install WARP & Privoxy (HTTP Bridge)
        run: |
          # 1. 安装 Cloudflare WARP 和 Privoxy
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          
          sudo apt-get update
          sudo apt-get install -y cloudflare-warp privoxy

          # 2. 配置 WARP (SOCKS5 端口 40000)
          sudo warp-cli --accept-tos registration new
          sudo warp-cli --accept-tos mode proxy
          sudo warp-cli --accept-tos proxy port 40000
          sudo warp-cli --accept-tos connect
          
          # 等待 WARP 启动
          sleep 3

          # 3. 配置 Privoxy (将 HTTP 8118 转为 SOCKS5 40000)
          # listen-address 0.0.0.0:8118 让 Docker 容器可以访问它
          echo "listen-address 0.0.0.0:8118" | sudo tee -a /etc/privoxy/config
          echo "forward-socks5 / 127.0.0.1:40000 ." | sudo tee -a /etc/privoxy/config
          
          # 重启 Privoxy 使配置生效
          sudo systemctl restart privoxy
          
          # 4. 验证链路 (通过 HTTP 代理访问)
          echo "Testing Proxy Chain..."
          curl -x http://127.0.0.1:8118 -s https://www.cloudflare.com/cdn-cgi/trace | grep "warp=on" || echo "Check failed but trying anyway..."
      # ----------------------------------------

      - name: PR Agent action step
        uses: qodo-ai/pr-agent@main
        env:
          ANTHROPIC__KEY: ${{ secrets.ANTHROPIC_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          
          HTTPS_PROXY: "http://172.17.0.1:8118"
          HTTP_PROXY: "http://172.17.0.1:8118"
          
          github_action_config.auto_review: "true"
          github_action_config.auto_describe: "true"